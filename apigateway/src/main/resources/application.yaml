server:
  port: 8080

spring:
  main:
    web-application-type: reactive
  application:
    name: api-gateway
  cloud:
    gateway:
      server:
        webflux:
          routes:
            - id: routes-service
              uri: ${TRIP_SERVICE_URL:http://localhost:8085}
              predicates:
                - Path=/routes/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: routes-service
                    fallbackUri: forward:/fallback
            - id: trips-service
              uri: ${TRIP_SERVICE_URL:http://localhost:8085}
              predicates:
                - Path=/trips/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: trips-service
                    fallbackUri: forward:/fallback
            - id: inventory-service
              uri: ${INVENTORY_SERVICE_URL:http://localhost:8082}
              predicates:
                - Path=/inventory/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: inventory-service
                    fallbackUri: forward:/fallback
            - id: payment-service
              uri: ${PAYMENT_SERVICE_URL:http://localhost:8084}
              predicates:
                - Path=/payments/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: payment-service
                    fallbackUri: forward:/fallback
            - id: booking-service
              uri: ${BOOKING_SERVICE_URL:http://localhost:8081}
              predicates:
                - Path=/booking,/booking/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: booking-service
                    fallbackUri: forward:/fallback
            - id: order-service
              uri: ${ORDER_SERVICE_URL:http://localhost:8083}
              predicates:
                - Path=/orders/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: order-service
                    fallbackUri: forward:/fallback
            - id: user-service-me
              uri: ${USER_SERVICE_URL:http://localhost:8086}
              predicates:
                - Path=/users/me/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: user-service-me
                    fallbackUri: forward:/fallback
            - id: user-service-admin
              uri: ${USER_SERVICE_URL:http://localhost:8086}
              predicates:
                - Path=/admin/users/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: user-service-admin
                    fallbackUri: forward:/fallback

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:8091/realms/ticketing-security-realm}
          jwk-set-uri: ${KEYCLOAK_JWKS_URI:http://localhost:8091/realms/ticketing-security-realm/protocol/openid-connect/certs}

keycloak:
  auth:
    jwk-set-uri: ${KEYCLOAK_JWKS_URI:http://localhost:8091/realms/ticketing-security-realm/protocol/openid-connect/certs}

springdoc:
  swagger-ui:
    path: /swagger-ui.html
    urls:
      - name: Trip Service
        url: /docs/tripservice/v3/api-docs
      - name: Inventory Service
        url: /docs/inventoryservice/v3/api-docs
      - name: Booking Service
        url: /docs/bookingservice/v3/api-docs
      - name: Order Service
        url: /docs/orderservice/v3/api-docs
      - name: Payment Service
        url: /docs/paymentservice/v3/api-docs
      - name: User Service
        url: /docs/userservice/v3/api-docs
  api-docs:
    path: /v3/api-docs

security:
  excluded:
    urls: /swagger-ui.html, /swagger-ui/**, /docs/**, /v3/api-docs/**, /swagger-resources/**, /api-docs/**, /routes/**, /trips/**, /actuator/**

logging:
  level:
    root: INFO
    org.example.apigateway: INFO
    org.springframework.cloud.gateway: INFO

management:
  tracing:
    sampling:
      probability: 1.0
  health:
    circuitbreakers:
      enabled: true
  endpoints:
    web:
      exposure:
        include: "*"
      base-path: /actuator
  endpoint:
    gateway:
      access: read_only
    health:
      show-details: always
  prometheus:
    metrics:
      export:
        enabled: true

resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 8
        failureRateThreshold: 50
        minimum-number-of-calls: 4
        waitDurationInOpenState: 5s
        permittedNumberOfCallsInHalfOpenState: 2
        automaticTransitionFromOpenToHalfOpenEnabled: true
  timelimiter:
    configs:
      default:
        timeout-duration: 3s
  retry:
    configs:
      default:
        max-attempts: 3
        wait-duration: 2s
